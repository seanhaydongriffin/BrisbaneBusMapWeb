<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 600px;
      }
      /* Optional: Makes the sample page fill the window. */
/*      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }*/
	  
	  table {
	    border-collapse: collapse;
		}
	  
	  td, th {
		  border: 1px solid;
		  text-align: left;
		}
	  
    </style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  </head>
  <body>
    <p><div id="message">hello</div></p>
    <div id="map"></div>
	<br>
	<table id="my-table">
		<thead>
			<tr><th>My Service Name</th><th>My Service Period</th><th>My Service Direction</th><th>My Stop #</th><th>My Stop Seq #</th></tr>
		</thead>
		<tbody>
		</tbody>
	</table>
	<br>
	<table id="data-table">
		<thead>
			<tr><th>Vehicle ID</th><th>Direction</th><th>Lat</th><th>Lng</th><th>Next Stop #</th><th>Next Stop Seq #</th><th>Distance</th><th>Est. Arrival</th></tr>
		</thead>
		<tbody>
		</tbody>
	</table>

    <script>
		var map;
		var route_markers = [];
		var bus_markers = [];
		var my_route_id = "";
		var my_stop_sequence = "";
		var my_stop_lat;
		var my_stop_lng;
		var my_stops;
		
		var my_service_short_name = "130";
//		var my_service_period = "Weekday";
		var my_service_period = "Saturday";
//		var my_service_period = "Sunday";
		var my_service_direction = "0";
		var my_stop_id = "10763";

/*		
		var my_service_short_name = "GLKN";
//		var my_service_period = "Weekday";
		var my_service_period = "Saturday";
		var my_service_direction = "0";
		var my_stop_id = "600821";
*/
		function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
				center: {lat: -27.641270, lng: 153.049400},
				zoom: 15
			});

			var trafficLayer = new google.maps.TrafficLayer();
			trafficLayer.setMap(map);

			// get my route id
			
			
//			var input_data = {serviceShortName: '" + my_service_short_name + "', servicePeriod: '" + my_service_period + "', serviceDirection: '" + my_service_direction + "'};
			var input_data = {serviceShortName: my_service_short_name, servicePeriod: my_service_period, serviceDirection: my_service_direction};
		//	alert(input_data);
			
			$.post("get_route_id.php", input_data, function(data, status){
				my_route_id = data.trim();
//				alert("aaa"+my_route_id+"bbb");
				
				// add the route markers
				
						
				$.post("get_stops.php", input_data, function(data, status){
			//		alert(data);
					//var my_stops = JQuery.parseJSON(data);
					my_stops = JSON.parse(data);
		//			alert(my_stops[0].lat);
		//			$('#message').text(data);
					
		//			deleteMarkers();
					
					for (var i in my_stops)
					{
						 

						if (my_stops[i].id == my_stop_id)
						{
							my_stop_sequence = my_stops[i].sequence;
							my_stop_lat = my_stops[i].lat;
							my_stop_lng = my_stops[i].lng;
							addRouteMarker(parseFloat(my_stops[i].lat), parseFloat(my_stops[i].lng), 1, my_stops[i].sequence);
							map.setCenter({lat: parseFloat(my_stops[i].lat), lng: parseFloat(my_stops[i].lng)});
						} else
						{
							addRouteMarker(parseFloat(my_stops[i].lat), parseFloat(my_stops[i].lng), 0.5, my_stops[i].sequence);

						}
					}
					
//					$('#my-table').children('tbody').html('<tr><td>' + my_service_short_name + '</td><td>' + my_service_period + '</td><td>' + my_service_direction + '</td><td>' + my_stop_id + '</td><td>' + my_stop_sequence + '</td></tr>');
					$('#my-table').children('tbody').html('<tr><td>' + my_service_short_name + '</td><td>' + my_service_period + '</td><td>' + my_service_direction + '</td><td>' + my_stop_id + '</td><td>' + my_stop_sequence + '</td></tr>');

				
					update_map();
					var myVar = setInterval(update_map, 10000);
				});		
			});		
			
			


			  
			// Adds a marker to the map and push to the array.
			function addRouteMarker(objlat, objlng, opacity, stopid) {
			
				var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';

				var marker = new google.maps.Marker({
					position: {lat: objlat, lng: objlng},
					label: stopid,
					map: map,
					icon: image
				});
				
				marker.setOpacity(opacity);
				
				route_markers.push(marker);
			}
			  
			// Sets the map on all markers in the array.
			function setMapOnAllRouteMarkers(map) {
				for (var i = 0; i < route_markers.length; i++) {
					route_markers[i].setMap(map);
				}
			}

			// Removes the markers from the map, but keeps them in the array.
			function clearRouteMarkers() {
				setMapOnAllRouteMarkers(null);
			}

			// Shows any markers currently in the array.
			function showRouteMarkers() {
				setMapOnAllRouteMarkers(map);
			}

			// Deletes all markers in the array by removing references to them.
			function deleteRouteMarkers() {
				clearRouteMarkers();
				route_markers = [];
			}
			  
			// Adds a marker to the map and push to the array.
			function addBusMarker(objlat, objlng, label2) {
				var marker = new google.maps.Marker({
					position: {lat: objlat, lng: objlng},
					label: label2,
					map: map
				});
				bus_markers.push(marker);
			}
			  
			// Sets the map on all markers in the array.
			function setMapOnAllBusMarkers(map) {
				for (var i = 0; i < bus_markers.length; i++) {
					bus_markers[i].setMap(map);
				}
			}

			// Removes the markers from the map, but keeps them in the array.
			function clearBusMarkers() {
				setMapOnAllBusMarkers(null);
			}

			// Shows any markers currently in the array.
			function showBusMarkers() {
				setMapOnAllBusMarkers(map);
			}

			// Deletes all markers in the array by removing references to them.
			function deleteBusMarkers() {
				clearBusMarkers();
				bus_markers = [];
			}
	  
	  
			function setNoItemsInfo()
			{
				if ($('#data-table').length < 1)
				
					return; //not configured.
				
				if ($('#data-table').children('tbody').length > 0)
				
					$('#data-table').children('tbody').html("");
				else
				
					$('#data-table').append('<tbody></tbody>');
			}	  
				  
			function loadTable(tableId, fields, data)
			{
				var rows = '';
				
				$.each(data, function(index, item)
				{
					if (item['direction'] == my_service_direction)
					{
						var row = '<tr>';
						
						$.each(fields, function(index, field)
						{
							row += '<td>' + item[field+''] + '</td>';
						});
						
						rows += row + '<tr>';
					}
				});
				
				$('#' + tableId).children('tbody').html(rows);
			}	  
	  
			function update_map() {
		  		
				var input_data = {serviceShortName: my_route_id, myLat: my_stop_lat, myLng: my_stop_lng};
//				alert("aaa"+my_route_id+"bbb");
				
				$.post("get_buses.php", input_data, function(data, status){
					var obj = JSON.parse(data);
//					$('#message').text(data);
					
					deleteBusMarkers();
					var map_centered = false;

					
					for (var i in obj)
					{
						// if the bus is going in my direction
						
						if (obj[i].direction == my_service_direction)
						{					
							var bus_before_my_stop = false;
							
							for (var j in my_stops)
							{
								// is the buses next stop is found in the list of stops
								
								if (my_stops[j].id == obj[i].stop_id)
								{
									obj[i].stop_sequence = my_stops[j].sequence;
								
									// if the buses next stop sequence is lower than my bus stops sequence then we can catch this bus
									if (parseInt(obj[i].stop_sequence) <= parseInt(my_stop_sequence))
									
										bus_before_my_stop = true;
									
								}
							}
							
							if (bus_before_my_stop)
							
								addBusMarker(parseFloat(obj[i].lat), parseFloat(obj[i].lng), obj[i].id);
							else
							
								obj[i].arrival_time = '';
								
							obj[i].distance = obj[i].distance + " m";
//							addBusMarker(parseFloat(obj[i].lat), parseFloat(obj[i].lng), obj[i].stop_id);
//							addBusMarker(parseFloat(obj[i].lat), parseFloat(obj[i].lng), obj[i].direction);
						}
	
					
	/*				
						if (obj[i].direction == my_service_direction)
						
							addBusMarker(parseFloat(obj[i].lat), parseFloat(obj[i].lng), obj[i].stop_id);
//							addBusMarker(parseFloat(obj[i].lat), parseFloat(obj[i].lng), obj[i].direction);
		*/
//						 if (!map_centered)
	//					 {
		//					map.setCenter(bus_markers[0].getPosition());
			//				map_centered = true;
				//		 }
					}
					
					setNoItemsInfo();
					loadTable('data-table', ['id', 'direction', 'lat', 'lng', 'stop_id', 'stop_sequence', 'distance', 'arrival_time'], obj);


					
				});		
			}
		} 
	  
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxmL_c2vxX1_sPMWqs2QJlodEDJb5G_ZA&callback=initMap"
    async defer></script>
  </body>
</html>